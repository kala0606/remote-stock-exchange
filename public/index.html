<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Remote Stock Exchange</title>
  <!-- <base href="/remote-stock-exchange/"> -->
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div id="title-bar">
    <img src="/logo.svg" alt="Logo" class="app-logo-titlebar" style="height:18px; margin-right:8px; vertical-align:middle;" />
    <span id="game-title-text">Remote Stock Exchange</span>
    <button id="helpButton" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); padding:0; font-size:16px; background:none; color:#000000; border:none; cursor:pointer; width:20px; height:20px; display:flex; align-items:center; justify-content:center; z-index:2001;">?</button>
  </div>

  <div id="main-content-wrapper">
    <div id="lobby" class="screen">
      <img src="/logo.svg" alt="Logo" class="app-logo-lobby" style="height:48px; margin-bottom:10px; display:block; margin-left:auto; margin-right:auto;" />
      <h1>Remote Stock Exchange</h1>
      
      <div class="lobby-input-group">
        <label for="playerName">Your Name:</label>
        <input type="text" id="playerName" placeholder="Enter your name">
      </div>

      <div class="controls">
        <div class="create-room-section">
          <button id="createRoom">Create Room</button>
        </div>
        <div class="join-section">
          <p>Or Join an Existing Room:</p>
          <div class="join-controls">
            <input type="text" id="roomCode" placeholder="Room Code">
            <button id="joinRoom">Join Room</button>
          </div>
        </div>
      </div>
      <div id="playerList"></div>
      <button id="startGame" style="display: none;">Start Game</button>
    </div>

    <div id="game" class="screen" style="display: none;">
      <div class="game-layout">
        <div class="game-left">
          <div id="info-bar">
            <span id="period">Period 1</span>
            <span id="turn-timer" style="display: none; font-weight: bold; color: #ffffff; background-color: #4CAF50; padding: 4px 8px; border-radius: 4px; font-size: 0.9em;">
              <span id="timer-display">00:00</span>
            </span>
          </div>
          
          <!-- Activity Log Panel -->
          <div id="activity-log-panel" class="panel" style="margin-top: 15px;">
              <div class="activity-log-header" style="cursor: pointer;" onclick="
                  const logContent = this.nextElementSibling;
                  const logIcon = this.querySelector('.expand-icon');
                  if (logContent.style.display === 'none') {
                      logContent.style.display = 'block';
                      logIcon.textContent = '▼';
                  } else {
                      logContent.style.display = 'none';
                      logIcon.textContent = '▶';
                  }
              ">
                  <h4>Activity Log <span class="expand-icon">▼</span></h4>
              </div>
              <div class="activity-log-content" style="display: block; max-height: 250px; overflow-y: auto; font-size: 0.9em; line-height: 1.4;">
                  <!-- Log entries will be added here by client.js -->
              </div>
          </div>
          
          <div id="portfolio-panel" class="panel">
            <h4>Your Portfolio</h4>
            <div id="portfolio-content">
              <div id="portfolio-summary">
                <div class="portfolio-item">
                  <span class="portfolio-label">Cash:</span>
                  <span id="portfolio-cash" class="portfolio-value">₹600k</span>
                </div>
                <div class="portfolio-item">
                  <span class="portfolio-label">Portfolio:</span>
                  <span id="portfolio-value" class="portfolio-value">₹0</span>
                </div>
                <div class="portfolio-item">
                  <span class="portfolio-label">Total:</span>
                  <span id="portfolio-total" class="portfolio-value">₹600k</span>
                </div>
              </div>
              <div id="portfolio-holdings">
                <!-- Holdings will be populated by JavaScript -->
              </div>
            </div>
          </div>
          <div id="market-board-container"></div>
          <div id="controls">
            <div class="action-buttons">
              <button id="buy">Buy</button>
              <button id="sell">Sell</button>
              <button id="shortSell">Short Sell</button>
              <!-- <button id="windfall">Play Windfall</button> -->
              <!-- <button id="pass">Pass</button> -->
              <button id="endTurn">End Turn</button>
            </div>
            <div class="admin-action-buttons">
              <button id="advancePeriod" style="display: none;">Advance Period</button>
              <button id="adminEndGameBtn" style="display: none;">End Game</button>
            </div>
          </div>
          <div id="player-hand-container" class="panel">
              <div class="hand-header" style="cursor: pointer;" onclick="
                  const handContent = this.nextElementSibling;
                  const handIcon = this.querySelector('.expand-icon');
                  if (handContent.style.display === 'none') {
                      handContent.style.display = 'block';
                      handIcon.textContent = '▼';
                  } else {
                      handContent.style.display = 'none';
                      handIcon.textContent = '▶';
                  }
              ">
                  <h4>Your Hand <span class="expand-icon">▼</span></h4>
              </div>
              <div class="hand-content" style="display: block;">
                  <!-- Player hand cards will be rendered here -->
              </div>
          </div>
          <div id="hand-summary" class="panel" style="display: none;">
              <h4>Hand Price Impact</h4>
              <div id="hand-summary-content"></div>
          </div>

          <div id="price-log-panel" class="panel" style="display: block; max-height: 200px; overflow-y: auto; margin-top: 15px;">
              <h4>Period Price Log</h4>
              <table id="price-log-table">
                  <thead>
                      <tr>
                          <th>Period</th>
                          <!-- Company headers will be added dynamically -->
                      </tr>
                  </thead>
                  <tbody id="price-log-table-body">
                      <!-- Log rows will be added dynamically -->
                  </tbody>
              </table>
          </div>

          <!-- *** NEW: General Rights Offers Panel *** -->
          <div id="general-rights-offers-panel" class="panel" style="display: none; margin-top: 15px; padding: 15px; background: rgba(220, 255, 220, 0.7); border: 1px solid #a3d9a5;">
              <h4>Available Rights Offers</h4>
              <p style="font-size: 0.9em; margin-bottom: 10px;">Click a company to exercise rights (1 per 2 owned @ half initial price, 1000s lots). This uses 1 transaction.</p>
              <div id="general-rights-list" style="display: flex; flex-direction: column; gap: 8px;">
                  <!-- Buttons will be added here by client.js -->
              </div>
          </div>


          <!-- NEW: Open Short Positions Panel -->
          <div id="open-shorts-panel" class="panel" style="display: none; margin-top: 15px;">
              <h4>Open Short Positions</h4>
              <div id="open-shorts-content" style="font-size: 0.9em; line-height: 1.5;">
                  <!-- Short positions will be listed here by client.js -->
                  <!-- Example:
                  <div class="short-position-item">
                      <span>WIPRO: 1000 @ ₹150 (Current: ₹140) P&L: +₹10,000</span>
                      <button class="cover-short-btn" data-symbol="WIPRO">Cover</button>
                  </div>
                  -->
              </div>
              <p id="no-open-shorts-msg" style="display: block;">You have no open short positions.</p>
          </div>

        </div>
      </div>
      
      <div class="game-right">
        <div id="leaderboard" class="panel leaderboard">
          <h2>Leaderboard</h2>
          <div class="leaderboard-content"></div>
        </div>
      </div>

      <div id="transaction-modal" class="modal">
          <div class="modal-content">
              <h2 id="transaction-type">Buy/Sell Shares</h2>
              <select id="company">
                <option value="" disabled selected>Select a company</option>
              </select>
              <div class="quantity-input-container">
                <input type="number" id="quantityInput" placeholder="Quantity (multiples of 1000)" min="1000" step="1000">
                <button type="button" class="quantity-btn increment">+</button>
                <button type="button" class="quantity-btn decrement">-</button>
              </div>
              <div id="costInfo" style="margin-top: 10px; margin-bottom: 10px; min-height: 40px; font-size: 0.9em;">Select a company and enter quantity.</div>
              <div class="button-group">
                  <button id="confirm">Confirm</button>
                  <button id="cancel">Cancel</button>
              </div>
          </div>
      </div>

      <div id="rights-issue-modal" class="modal">
          <div class="modal-content">
              <h2>Rights Issue</h2>
              <p>Select a company to purchase rights shares (1 per 2 owned) at half its initial price. Shares are issued in multiples of 1000.</p>
              <select id="rightsCompanySelect"></select>
              <div style="margin-top: 10px; margin-bottom: 10px;">
                  <label for="desiredRightsSharesInput">How many shares do you want to try to acquire via rights?</label>
                  <div class="quantity-input-container">
                    <input type="number" id="desiredRightsSharesInput" placeholder="e.g., 2000" min="1" style="width: 100%; margin-top: 5px;">
                    <button type="button" class="quantity-btn increment">+</button>
                    <button type="button" class="quantity-btn decrement">-</button>
                  </div>
              </div>
              <div id="rights-cost-info" style="margin-top: 10px; font-size: 0.9em;"></div>
              <div class="button-group">
                  <button id="confirmRightsIssue">Confirm Purchase</button>
                  <button id="cancelRightsIssue" class="button-cancel">Cancel</button>
              </div>
          </div>
      </div>

      <!-- *** NEW: General Rights Issue Modal *** -->
      <div id="general-rights-issue-modal" class="modal">
          <div class="modal-content">
              <h2>Exercise General Rights Issue</h2>
              <p>For <strong id="generalRightsCompanyName">[Company]</strong>. Exercise rights (1 share per 2 owned) at <strong id="generalRightsPricePerShare">₹[Price]</strong> per share. Shares are issued in multiples of 1000.</p>
              <div style="margin-top: 10px; margin-bottom: 10px;">
                  <label for="desiredGeneralRightsSharesInput">How many shares do you want to acquire via these rights?</label>
                  <div class="quantity-input-container">
                    <input type="number" id="desiredGeneralRightsSharesInput" placeholder="e.g., 1000, 2000" min="1" style="width: 100%; margin-top: 5px;">
                    <button type="button" class="quantity-btn increment">+</button>
                    <button type="button" class="quantity-btn decrement">-</button>
                  </div>
              </div>
              <div id="general-rights-cost-info" style="margin-top: 10px; font-size: 0.9em;"></div>
              <div class="button-group">
                  <button id="confirmGeneralRightsIssue">Confirm Purchase</button>
                  <button id="cancelGeneralRightsIssue">Cancel</button>
              </div>
          </div>
      </div>

      <!-- NEW: Short Sell Modal -->
      <div id="short-sell-modal" class="modal">
          <div class="modal-content">
              <h2 id="shortSellTitle">Initiate Short Sell</h2>
              <div class="modal-details">
                  <p style="font-size:0.9em; margin-bottom:10px;">Select a company to short. You will borrow its shares and sell them, hoping the price drops so you can buy them back cheaper to cover. This uses 1 transaction.</p>
              </div>
              <select id="shortCompanySelect">
                <option value="" disabled selected>Select a company</option>
                <!-- Options populated by JS -->
              </select>
              <div class="quantity-input-container">
                <input type="number" id="shortQuantityInput" placeholder="Quantity (multiples of 1000)" min="1000" step="1000">
                <button type="button" class="quantity-btn increment">+</button>
                <button type="button" class="quantity-btn decrement">-</button>
              </div>
              <div id="shortSellInfoDiv" style="margin-top: 10px; margin-bottom: 10px; min-height: 40px; font-size: 0.9em;">Select company and quantity.</div>
              <div class="button-group">
                  <button id="confirmShortSellBtn">Confirm Short</button>
                  <button id="cancelShortSellBtn">Cancel</button>
              </div>
          </div>
      </div>

      <!-- Help Modal -->
      <div id="help-modal" class="modal">
          <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
              <h2>How to Play</h2>
              <div class="help-content" style="line-height:1.5;">
                  <h3>Objective</h3>
                  <p>Grow your total worth (Cash + Portfolio Value) to top the leaderboard by game end.</p>
                  <h3>Setup</h3>
                  <ul>
                    <li>Starting cash: ₹600,000</li>
                    <li>Companies: 6 listed stocks with distinct profiles</li>
                    <li>Your hand: 10 cards (Price and Windfall)</li>
                    <li>Transactions per period: 3</li>
                    <li>Trade in 1000-share lots</li>
                  </ul>
                  <h3>Game Flow</h3>
                  <ol>
                    <li>Create or join a room; first player is Admin.</li>
                    <li>Admin starts the game; a random player goes first.</li>
                    <li>Players take turns within a Round; up to 3 Rounds per Period.</li>
                    <li>At checkpoints, Admin resolves prices and advances to the next Period.</li>
                    <li>Admin ends the game; highest total worth wins.</li>
                  </ol>
                  <h3>Your Turn</h3>
                  <ul>
                    <li>Buy, Sell, Short Sell</li>
                    <li>Exercise eligible General Rights (when available)</li>
                    <li>Play a card (card rules apply)</li>
                    <li>Pass or End Turn</li>
                  </ul>
                  <h3>Actions</h3>
                  <p><strong>Buy</strong>: Choose a company, enter quantity in 1000s. Pay Current Price × Quantity. Respect share caps.</p>
                  <p><strong>Sell</strong>: Choose a company you hold, enter quantity in 1000s. Receive Current Price × Quantity.</p>
                  <p><strong>Short Sell</strong>: Borrow and sell now; buy back later. Collateral equal to Current Price × Quantity is held. Profit/Loss ≈ (Open − Cover) × Quantity. Shorts auto-cover at period end if not covered.</p>
                  <p><strong>Rights Issue (Personal)</strong>: Playing a RIGHTS card lets you buy at half initial price, 1 right per 2 owned, in 1000s.</p>
                  <p><strong>General Rights Offer</strong>: When any player triggers RIGHTS, a round-limited offer appears. Same rules as above.</p>
                  <h3>Turns, Rounds, Periods</h3>
                  <p>Each Period has up to 3 Rounds. Turn order loops all players. When it returns to the starter, the Round advances. Admin resolves prices at checkpoints and then advances the Period.</p>
                  <h3>Price Resolution</h3>
                  <p>Unplayed Price cards in hands contribute to net company price changes when Admin resolves. See the Price Log for snapshots.</p>
                  <h3>Leadership Roles</h3>
                  <ul>
                    <li>President: Own ≥ 50,000 shares in a company</li>
                    <li>Chairman: Own ≥ 100,000 shares in a company</li>
                  </ul>
                  <h3>UI Guide</h3>
                  <ul>
                    <li>Info Bar: Period/Round, turn indicator, transactions</li>
                    <li>Actions: Buy, Sell, Short, End Turn</li>
                    <li>Portfolio: Cash, Portfolio Value, Total Worth, Holdings</li>
                    <li>Hand: Your cards (click to read/play)</li>
                    <li>Price Log & Activity Log</li>
                    <li>Rights Panel and Open Shorts</li>
                  </ul>
                  <h3>Winning</h3>
                  <p>When Admin ends the game, final standings and worth history are shown. Highest Total Worth wins.</p>
                  <h3>Strategy Tips</h3>
                  <ul>
                    <li>Build positions early in promising companies.</li>
                    <li>Keep cash for rights and shorts.</li>
                    <li>Use shorts with a clear bearish view.</li>
                    <li>Watch 50k/100k share thresholds.</li>
                    <li>Plan turns to conserve transactions.</li>
                  </ul>
                  <div class="button-group">
                      <button id="closeHelpBtn">Close</button>
                  </div>
              </div>
          </div>
      </div>

    </div>

    <!-- NEW: Game Over Screen -->
    <div id="game-over-screen" class="screen" style="display: none; padding: 20px; max-width: 1400px;">
      <div class="game-over-header">
        <img src="/logo.svg" alt="Logo" class="app-logo-endscreen" style="height:48px; margin-bottom:12px;" />
        <h2>Game Analytics & Results</h2>
        <h4 id="winner-announcement" style="margin-bottom: 20px;">Calculating winner...</h4>
      </div>

      <!-- Summary Cards Section -->
      <div class="analytics-grid">
        <div class="analytics-card" id="game-summary-card">
          <h3>Game Summary</h3>
          <div id="game-summary-content"></div>
        </div>
        
        <div class="analytics-card" id="top-performers-card">
          <h3>Top Performers</h3>
          <div id="top-performers-content"></div>
        </div>
        
        <div class="analytics-card" id="key-metrics-card">
          <h3>Key Metrics</h3>
          <div id="key-metrics-content"></div>
        </div>
      </div>

      <!-- Player Worth Chart -->
      <div class="analytics-section">
        <h3>Player Net Worth Over Time</h3>
        <div class="chart-container">
          <canvas id="playerWorthChart"></canvas>
        </div>
      </div>

      <!-- Detailed Analytics Sections -->
      <div class="analytics-sections">
        <!-- Final Standings -->
        <div class="analytics-section">
          <h3>Final Standings</h3>
          <div id="final-standings-table"></div>
        </div>

        <!-- Company Performance -->
        <div class="analytics-section">
          <h3>Company Performance</h3>
          <div id="company-performance-content"></div>
        </div>

        <!-- Player Detailed Stats -->
        <div class="analytics-section">
          <h3>Player Performance Breakdown</h3>
          <div id="player-performance-breakdown"></div>
        </div>

        <!-- Transaction Analysis -->
        <div class="analytics-section">
          <h3>Transaction & Activity Analysis</h3>
          <div id="transaction-analysis-content"></div>
        </div>

        <!-- Rights & Shorts Analysis -->
        <div class="analytics-section">
          <h3>Rights Offerings & Short Positions</h3>
          <div id="rights-shorts-analysis"></div>
        </div>

        <!-- Leadership Analysis -->
        <div class="analytics-section">
          <h3>Company Leadership</h3>
          <div id="leadership-analysis"></div>
        </div>

        <!-- Game Timeline -->
        <div class="analytics-section">
          <h3>Game Timeline</h3>
          <div id="game-timeline-content"></div>
        </div>
      </div>

      <div id="wisdom-quote" class="wisdom-quote"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script> -->
  <script src="gradient-shader.js"></script>
  <script src="client.js"></script>
</body>
</html>